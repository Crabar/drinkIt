<?xml version="1.0"?>
<!--
  Created by Crabar on 02.07.2014.
-->
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009" xmlns:s="library://ns.adobe.com/flex/spark"
         xmlns:mx="library://ns.adobe.com/flex/mx" xmlns:flextras="spark.flextras.autoCompleteComboBox.*"
         xmlns:supportclasses="views.supportClasses.*"
         creationComplete="creationCompleteHandler(event)">
    <s:layout>
        <s:VerticalLayout paddingBottom="10"/>
    </s:layout>


    <fx:Script>
        <![CDATA[
        import controllers.CocktailAdminController;

        import models.CocktailAdminModel;
        import models.CocktailModel;
        import models.IngredientsModel;
        import models.supportClasses.CocktailTypes;
        import models.supportClasses.Ingredient;
        import models.supportClasses.OptionParameters;

        import mx.controls.Alert;
        import mx.events.FlexEvent;

        import spark.events.IndexChangeEvent;

        [Bindable]
        private var _model:CocktailAdminModel;
        private var _controller:CocktailAdminController;

        private function loadCocktail(id:Number):void
        {

        }

        private function onIngrChooseChange(event:IndexChangeEvent):void
        {
            if (event.newIndex >= 0)
                _controller.addIngredientToCocktail(ingrChoose.selectedItem);

            ingrChoose.selectedIndex = -1;
            ingrChoose.validateProperties();
        }

        private function filterCBList(item:Object):Boolean
        {
            function isIngredientSelected(ingredient:Ingredient):Boolean
            {
                for (var i:uint = 0; i < _model.selectedIngredientsList.length; i++)
                {
                    if (_model.selectedIngredientsList.getItemAt(i).id == ingredient.id)
                        return true;
                }

                return false;
            }

            var inputValue:String = ingrChoose.typeAheadText.toLowerCase();
            var ingr:Ingredient = Ingredient(item);

            if (String(ingr.name).toLowerCase().search(inputValue) > -1 && (!isIngredientSelected(ingr)))
                return true;

            return false;
        }

        private function creationCompleteHandler(event:FlexEvent):void
        {
            _model = new CocktailAdminModel();
            _controller = new CocktailAdminController(_model);
        }

        private function onSaveButtonClick(event:Event):void
        {
            trace(1);
        }

        private function onCocktailOptionsChange(event:IndexChangeEvent):void
        {
            var selectedItems:Vector.<Object> = List(event.currentTarget).selectedItems;
            _controller.updateOptions(selectedItems);
        }

        private function onLoadButtonClick(event:MouseEvent):void
        {
            loadCocktail(Number(idInput.text));
        }


        private var _photoLoader:Loader;
        private var _fileLoad:FileReference;

        private function onLoadPhotoButtonClick(event:MouseEvent):void
        {
            _fileLoad = new FileReference();
            _fileLoad.addEventListener(Event.SELECT, onFileSelect);
            _fileLoad.addEventListener(Event.CANCEL, onBrowseCancel);
            _fileLoad.addEventListener(SecurityErrorEvent.SECURITY_ERROR,
                    onSecurityError);
            _fileLoad.addEventListener(IOErrorEvent.IO_ERROR, onPhotoLoadError);
            _fileLoad.addEventListener(Event.COMPLETE, onPhotoLoaded);

            trace(_fileLoad.browse([new FileFilter("Images", "*.jpg;*.gif;*.png")]));


        }

        private function onSecurityError(event:SecurityErrorEvent):void
        {
            trace("security error");
        }

        private function onBrowseCancel(event:Event):void
        {
            trace("select cancel");
        }

        private function onFileSelect(event:Event):void
        {
            FileReference(event.currentTarget).load();
            trace("selected");
        }

        private function onPhotoLoadError(event:IOErrorEvent):void
        {
            trace(event.errorID);
        }

        private function onPhotoLoaded(event:Event):void
        {
            _photoLoader = new Loader();
            _photoLoader.contentLoaderInfo.addEventListener(Event.COMPLETE, onPhotoConverted);
            _photoLoader.loadBytes(event.currentTarget.data);
        }

        private function onPhotoConverted(event:Event):void
        {
            var photo:Bitmap = LoaderInfo(event.currentTarget).content as Bitmap;

            if (photo.width < CocktailModel.BIG_IMAGE_WIDTH || photo.height < CocktailModel.BIG_IMAGE_HEIGHT)
            {
                Alert.show("Картинка слишком маленькая! Минимальный размер: " + CocktailModel.BIG_IMAGE_WIDTH + "x" + CocktailModel.BIG_IMAGE_HEIGHT);
                return;
            }

            cocktailPhoto.source = LoaderInfo(event.currentTarget).content;
        }

        private function onCocktailTypeChange(event:IndexChangeEvent):void
        {
            _controller.setCocktailType(List(event.currentTarget).selectedItem);
        }
        ]]>
    </fx:Script>

    <s:HGroup>
        <s:Button label="Создать"/>
        <s:Button label="Удалить"/>
        <s:Spacer width="1"/>
        <s:Button label="Сохранить" click="onSaveButtonClick(event)"/>
    </s:HGroup>
    <mx:HRule width="100%" strokeWidth="1" strokeColor="0x000000"/>
    <s:HGroup verticalAlign="middle">
        <s:TextInput id="idInput"/>
        <s:Button label="Загрузить" click="onLoadButtonClick(event)"/>
    </s:HGroup>
    <s:Group width="100%">
        <s:HGroup left="0" verticalAlign="middle">
            <s:TextInput id="titleInput"/>
            <s:CheckBox id="isDevelopCheckBox" label="в разработке"/>
        </s:HGroup>
        <s:Button label="Загрузить фото" right="0" click="onLoadPhotoButtonClick(event)"/>
    </s:Group>
    <s:HGroup width="100%" height="100%">
        <s:VGroup width="100%" height="100%">
            <s:TextArea id="descriptionInput" width="100%" textAlign="left" verticalAlign="top"/>
            <s:HGroup width="100%" height="100%">
                <s:VGroup width="100%" height="100%">
                    <flextras:AutoCompleteComboBoxLite id="ingrChoose" width="100%" height="26"
                                                       styleName="regularText"
                                                       itemRenderer="components.renderers.AutoCompleteRenderer"
                                                       skinClass="design.skins.LiveSearchComboBoxSkin"
                                                       focusSkin="{null}" focusRect="false"
                                                       filterFunction="filterCBList"
                                                       labelField="name" paddingLeft="0" prompt="Напишите ингредиент..."
                                                       change="onIngrChooseChange(event)"
                                                       dataProvider="{IngredientsModel.instance.ingredientsList}"/>
                    <s:DataGrid width="100%" height="100%" dataProvider="{_model.selectedIngredientsList}"
                                editable="true">
                        <s:columns>
                            <s:ArrayList>
                                <s:GridColumn headerText="Название" dataField="name" editable="false"/>
                                <s:GridColumn headerText="Количество" dataField="quantity" editable="true"/>
                            </s:ArrayList>
                        </s:columns>
                    </s:DataGrid>
                </s:VGroup>
                <s:List width="100%" change="onCocktailTypeChange(event)">
                    <s:dataProvider>
                        <s:ArrayList>
                            <fx:Object value="{CocktailTypes.SHOOTER}" label="shooter"/>
                            <fx:Object value="{CocktailTypes.SHORT_DRINK}" label="short"/>
                            <fx:Object value="{CocktailTypes.LONG_DRINK}" label="long"/>

                        </s:ArrayList>
                    </s:dataProvider>
                </s:List>
                <s:List width="100%" allowMultipleSelection="true" change="onCocktailOptionsChange(event)">
                    <s:dataProvider>
                        <s:ArrayList>
                            <fx:Object value="{OptionParameters.BURNING}" label="горящий"/>
                            <fx:Object value="{OptionParameters.CHECKED}" label="проверенный"/>
                            <fx:Object value="{OptionParameters.FLACKY}" label="слоенный"/>
                            <fx:Object value="{OptionParameters.IBA}" label="официальный"/>
                            <fx:Object value="{OptionParameters.WITH_ICE}" label="со льдом"/>
                        </s:ArrayList>
                    </s:dataProvider>
                </s:List>
            </s:HGroup>
        </s:VGroup>
        <supportclasses:CropImageContainer id="cocktailPhoto" width="{CocktailModel.BIG_IMAGE_WIDTH}"
                                           height="{CocktailModel.BIG_IMAGE_HEIGHT}" backgroundColor="#15ffda"/>
    </s:HGroup>
</s:Group>
